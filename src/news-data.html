<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="news-data">

  <script>

  (function() {

    var categoryList = [
      {name: 'top_stories', tag: '', title: 'Top Stories'},
      {ListID: 3, name: 'ocm', tag: 'office of the city manager', title: 'From City Manager'},
      {ListID: 4, name: 'parks', tag: 'parks and recreation', title: 'Parks and Recreation'},
      {ListID: 8, name: 'ed', tag: 'economic development', title: 'Economic Development'},
      {ListID: 7, name: 'pw', tag: 'public works', title: 'Public Works'}
    ];

    var textarea = document.createElement('textarea');

    Polymer({

      is: 'news-data',

      properties: {

        categories: {
          type: Array,
          value: categoryList,
          readOnly: true,
          notify: true
        },

        categoryName: String,

        articleId: String,

        offline: Boolean,

        loading: {
          type: Boolean,
          readOnly: true,
          notify: true
        },

        category: {
          type: Object,
          computed: '_computeCategory(categoryName)',
          notify: true
        },

        article: {
          type: Object,
          computed: '_computeArticle(category.items, articleId)',
          notify: true
        },

        failure: {
          type: Boolean,
          readOnly: true,
          notify: true
        }

      },

      observers: [
        '_fetchCategory(category, offline)'
      ],

      _computeArticle: function(categoryItems, articleId) {
        for (var i = 0; i < categoryItems.length; ++i) {
          var article = categoryItems[i];
          if (article.id === articleId) {
            return article;
          }
        }
        return null;
      },

      _computeCategory: function(categoryName) {
        for (var i = 0, c; c = this.categories[i]; ++i) {
          if (c.name === categoryName || c.tag === categoryName) {//HACK - //todo - have menu and article use same category property
            return c;
          }
        }
        return null;
      },

      _fetchCategory: function(category, offline, attempts) {
        // Don't fail if we become offline but already have a cached version, or if there's
        // nothing to fetch, or if already loading.
        if ((offline && category && category.items) || !category || this.loading) {
          this._setFailure(false);
          return;
        }
        this._fetch('https://api.auburnalabama.org/newsitem/' + category.tag + '/page/0',
          function(response) {
            this.set('category.items', this._parseCategoryItems(response));
          }.bind(this),
          attempts || 1 /* attempts */);

        this._fetch('https://api.auburnalabama.org/newsitem/' + category.tag + '/page/1',
          function(response) {
            this.set('category.moreItems', this._parseCategoryItems(response));
          }.bind(this),
          attempts || 1 /* attempts */);
      },

      _parseCategoryItems: function(response) {
        var items = [];

        for (var i = 0, item; item = response[i]; ++i) {
          items.push({
            headline: this._unescapeText(item.Name),
            href: this._getItemHref(item),
            id: item.ID,
            imageUrl: this._getItemImage(item),
            placeholder: item.placeholder || "data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAA8AAD/4QMxaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzExMSA3OS4xNTgzMjUsIDIwMTUvMDkvMTAtMDE6MTA6MjAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjJFNTQzRDI0QTM4RTExRTY5NjdCRDcxN0ZDQzkwNzU3IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjJFNTQzRDIzQTM4RTExRTY5NjdCRDcxN0ZDQzkwNzU3IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MUYyN0U2RkRBMzg3MTFFNjk2N0JENzE3RkNDOTA3NTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MUYyN0U2RkVBMzg3MTFFNjk2N0JENzE3RkNDOTA3NTciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAmQWRvYmUAZMAAAAABAwAVBAMGCg0AAATiAAAFEgAABUsAAAV4/9sAhAAGBAQEBQQGBQUGCQYFBgkLCAYGCAsMCgoLCgoMEAwMDAwMDBAMDg8QDw4MExMUFBMTHBsbGxwfHx8fHx8fHx8fAQcHBw0MDRgQEBgaFREVGh8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx//wgARCAAGAAoDAREAAhEBAxEB/8QAhwABAQAAAAAAAAAAAAAAAAAABQYBAQAAAAAAAAAAAAAAAAAAAAAQAAIDAQAAAAAAAAAAAAAAABADAAEEJBEAAQMDBQAAAAAAAAAAAAAAAgABEdESA0JiEzOjEgEAAAAAAAAAAAAAAAAAAAAQEwEAAgIDAQAAAAAAAAAAAAABEBEhMQBRkaH/2gAMAwEAAhEDEQAAAa0WP//aAAgBAQABBQLWp97OKf/aAAgBAgABBQIf/9oACAEDAAEFAh//2gAIAQICBj8CP//aAAgBAwIGPwI//9oACAEBAQY/ArgzEOOG5QZim3bDLT1eVF//2gAIAQEDAT8hYJl0gXNk3nWYR//aAAgBAgMBPyGP/9oACAEDAwE/IY//2gAMAwEAAhEDEQAAEEP/2gAIAQEDAT8Qf2TjokQgNtX5fTw4f//aAAgBAgMBPxCP/9oACAEDAwE/EI//2Q==",
            category: item.Tags,
            timeAgo: this._timeAgo(new Date(item.PublishDate).getTime()),
            author: item.author,
            summary: this._trimRight(item.Blurb, 100),
            readTime: //Math.max(2, Math.round(item.contentLength / 3000)) + '' +
                        '?? min read'
          });
        }

        return items;
      },

      _unescapeText: function(text) {
        textarea.innerHTML = text;
        return textarea.textContent;
      },

      _getItemHref: function(item) {
        return item.ID ? '/article/' + encodeURIComponent(item.Tags.toLowerCase()) + '/' + encodeURIComponent(item.ID) : null;
      },

      _getItemImage: function(item) {
        return item.NewsPhotoName ? 'https://static.auburnalabama.org/media/apps/news/' + item.NewsPhotoName : '';
      },

      _timeAgo: function(timestamp) {
        if (!timestamp)
          return ''

        var minutes = (Date.now() - timestamp) / 1000 / 60;
        if (minutes < 2)
          return '1 min ago';
        if (minutes < 60)
          return Math.floor(minutes) + ' mins ago';
        if (minutes < 120)
          return '1 hour ago';

        var hours = minutes / 60;
        if (hours < 24)
          return Math.floor(hours) + ' hours ago';
        if (hours < 48)
          return '1 day ago';

        return Math.floor(hours / 24) + ' days ago';
      },

      _trimRight: function(text, maxLength) {
        var breakIdx = text.indexOf(' ', maxLength);
        return breakIdx === -1 ? text : text.substr(0, breakIdx) + '...';
      },

      _formatHTML: function(html) {
        var template = document.createElement('template');
        template.innerHTML = html;

        // Remove h1, .kicker, and .date from content.
        // var h1 = template.content.querySelector('h1');
        // h1 && h1.remove();
        // var kicker = template.content.querySelector('.kicker');
        // kicker && kicker.remove();
        // var date = template.content.querySelector('.date');
        // date && date.remove();

        // Remove the first image if it's the same as the item image.
        // var image = template.content.querySelector('img');
        // if (image && this._isSameImageSrc(image.src, this.article.imageUrl)) {
        //   image.remove();
        // }

        // Remove width/height attributes from all images.
        var images = template.content.querySelectorAll('img');
        for (var i = 0; i < images.length; ++i) {
          var img = images[i];
          img.removeAttribute('width');
          img.removeAttribute('height');
        }

        return template.content.querySelector('.content').innerHTML;
      },

      // _isSameImageSrc: function(a, b) {
      //   var regex = /[^/]+\.(jpg|png|gif)/;
      //   var aMatch = regex.exec(a);
      //   var bMatch = regex.exec(b);
      //   return aMatch && bMatch && aMatch[0] === bMatch[0];
      // },

      _fetch: function(url, callback, attempts, isRaw) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', function(e) {
          this._setLoading(false);
          if (isRaw) {
            callback(e.target.responseText);
          } else {
            callback(JSON.parse(e.target.responseText));
          }
        }.bind(this));
        xhr.addEventListener('error', function(e) {
          // Flaky connections might fail fetching resources
          if (attempts > 1) {
            this.debounce('_fetch', this._fetch.bind(this, url, callback, attempts - 1), 200);
          } else {
            this._setLoading(false);
            this._setFailure(true);
          }
        }.bind(this));

        this._setLoading(true);
        this._setFailure(false);
        xhr.open('GET', url);
        xhr.send();
      },

      refresh: function() {
        if (this.categoryName) {
          // Try at most 3 times to get the items.
          this._fetchCategory(this.category, this.offline, 3);
        }
      }

    });

  })();

  </script>

</dom-module>

<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="news-data">

  <script>

  (function() {

    var apiRoot = 'https://api.auburnalabama.org/pressrelease/';
    var categoryList = [
      { id: 0, path: 'frontpage', name: 'top_stories', title: 'Top Stories'},
      { id: 3, path: 'list/Office of the City Manager/50', name: 'Office of the City Manager', title: 'From City Manager'},
      { id: 4, path: 'list/Parks and Recreation/24', name: 'Parks and Recreation', title: 'Parks and Recreation'},
      //{ id: 5, path: 'list/Public Safety - Police/12', name: 'Public Safety - Police', title: 'Police'},
      //{ id: 6, path: 'list/Planning/12', name: 'Planning', title: 'Planning'},
      { id: 7, path: 'list/Public Works/12', name: 'Public Works', title: 'Public Works'},
      { id: 8, path: 'list/Economic Development/12', name: 'Economic Development', title: 'Economic Development'}
    ];

    var textarea = document.createElement('textarea');

    Polymer({

      is: 'news-data',

      properties: {

        categories: {
          type: Array,
          value: categoryList,
          readOnly: true,
          notify: true
        },

        categoryName: String,

        articleId: String,

        offline: Boolean,

        loading: {
          type: Boolean,
          readOnly: true,
          notify: true
        },

        category: {
          type: Object,
          computed: '_computeCategory(categoryName)',
          notify: true
        },

        article: {
          type: Object,
          computed: '_computeArticle(category.items, articleId)',
          notify: true
        },

        failure: {
          type: Boolean,
          readOnly: true,
          notify: true
        }

      },

      observers: [
        '_fetchCategory(category, offline)',
        '_fetchArticle(article, offline)'
      ],

      _computeArticle: function(categoryItems, articleId) {
        for (var i = 0; i < categoryItems.length; ++i) {
          var article = categoryItems[i];
          if (article.id == articleId) {
            return article;
          }
        }
        return {
          id: articleId
        };
      },
/*this is junk, it's designed to get the content or format the content but the content is returned and formatted with _fetchCategoryItems and the article is set with _computeArticle. I can't even get _computeArticle to trigger from a fetch in this method*/
      _fetchArticle: function(article, offline) {
        // Don't fail if we become offline but already have a cached version, or if there's
        // nothing to fetch, or if already loading.
        if ((article && article.html) || !article || this.loading) {
          this._setFailure(false);
          return;
        }
/*
        if (!article.html && article.content) {
          this.set('article.html', this._formatHTML(article.content));
          return;
        }

        this._fetch(apiRoot + article.id,
          function(response) {
            var responseArticle = JSON.parse(response)[0];
            this.push('category.items', this._parseArticleItem(responseArticle));
          }.bind(this),
          3 , true);*/
      },

      _computeCategory: function(categoryName) {
        for (var i = 0, c; c = this.categories[i]; ++i) {
          if (c.name === categoryName) {
            return c;
          }
        }
        return null;
      },

      _fetchCategory: function(category, offline, attempts) {
        // Don't fail if we become offline but already have a cached version, or if there's
        // nothing to fetch, or if already loading.
        if ((offline && category && category.items) || !category || this.loading) {
          this._setFailure(false);
          return;
        }
        this._fetch(apiRoot + category.path,
          function(response) {
            this.set('category.items', this._parseCategoryItems(response));
          }.bind(this),
          attempts || 2 /* attempts */);
      },

      _parseCategoryItems: function(response) {
        var items = [];

        for (var i = 0, item; item = response[i]; ++i) {
          items.push(this._parseArticleItem(item));
        }

        return items;
      },

      _parseArticleItem: function(item) {
        return {
            headline: this._unescapeText(item.Title),
            href: this._getItemHref(item),
            id: item.PressReleaseID,
            imageUrl: this._getItemImage(item),
            placeholder: item.placeholder || "data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAA8AAD/4QMxaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzExMSA3OS4xNTgzMjUsIDIwMTUvMDkvMTAtMDE6MTA6MjAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjJFNTQzRDI0QTM4RTExRTY5NjdCRDcxN0ZDQzkwNzU3IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjJFNTQzRDIzQTM4RTExRTY5NjdCRDcxN0ZDQzkwNzU3IiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MUYyN0U2RkRBMzg3MTFFNjk2N0JENzE3RkNDOTA3NTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MUYyN0U2RkVBMzg3MTFFNjk2N0JENzE3RkNDOTA3NTciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAmQWRvYmUAZMAAAAABAwAVBAMGCg0AAATiAAAFEgAABUsAAAV4/9sAhAAGBAQEBQQGBQUGCQYFBgkLCAYGCAsMCgoLCgoMEAwMDAwMDBAMDg8QDw4MExMUFBMTHBsbGxwfHx8fHx8fHx8fAQcHBw0MDRgQEBgaFREVGh8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx//wgARCAAGAAoDAREAAhEBAxEB/8QAhwABAQAAAAAAAAAAAAAAAAAABQYBAQAAAAAAAAAAAAAAAAAAAAAQAAIDAQAAAAAAAAAAAAAAABADAAEEJBEAAQMDBQAAAAAAAAAAAAAAAgABEdESA0JiEzOjEgEAAAAAAAAAAAAAAAAAAAAQEwEAAgIDAQAAAAAAAAAAAAABEBEhMQBRkaH/2gAMAwEAAhEDEQAAAa0WP//aAAgBAQABBQLWp97OKf/aAAgBAgABBQIf/9oACAEDAAEFAh//2gAIAQICBj8CP//aAAgBAwIGPwI//9oACAEBAQY/ArgzEOOG5QZim3bDLT1eVF//2gAIAQEDAT8hYJl0gXNk3nWYR//aAAgBAgMBPyGP/9oACAEDAwE/IY//2gAMAwEAAhEDEQAAEEP/2gAIAQEDAT8Qf2TjokQgNtX5fTw4f//aAAgBAgMBPxCP/9oACAEDAwE/EI//2Q==",
            category: item.List ? item.List.ListName : '',
            timeAgo: this._timeAgo(new Date(item.DateAdded).getTime()),
            author: item.ContactPerson,
            authorPhone: item.ContactPhone.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'),
            authorTitle: item.ContactTitle,
            summary: this._trimRight(item.Summary, 100),
            html: this._formatHTML(item.PressRelease),
            mainPriority: item.MainPagePriority,
            priority: item.Priority,
            readTime: Math.max(1, Math.round(item.SearchableContent.length / 3000)) + ' min read'
          };
      },

      _unescapeText: function(text) {
        textarea.innerHTML = text;
        return textarea.textContent;
      },

      _getItemHref: function(item) {
        return item.List ? '/article/' + item.List.ListName + '/' + encodeURIComponent(item.PressReleaseID) : null;
      },

      _getItemImage: function(item) {
        return item.Picture ? 'https://static.auburnalabama.org/media/apps/news/' + item.Picture.PictureName : '';
      },

      _timeAgo: function(timestamp) {
        if (!timestamp)
          return ''

        var minutes = (Date.now() - timestamp) / 1000 / 60;
        if (minutes < 2)
          return '1 min ago';
        if (minutes < 60)
          return Math.floor(minutes) + ' mins ago';
        if (minutes < 120)
          return '1 hour ago';

        var hours = minutes / 60;
        if (hours < 24)
          return Math.floor(hours) + ' hours ago';
        if (hours < 48)
          return '1 day ago';

        return Math.floor(hours / 24) + ' days ago';
      },

      _trimRight: function(text, maxLength) {
        var breakIdx = text.indexOf(' ', maxLength);
        return breakIdx === -1 ? text : text.substr(0, breakIdx) + '...';
      },

      _formatHTML: function(html) {
        var template = document.createElement('template');
        template.innerHTML = html;

        // Remove h1, .kicker, and .date from content.
        // var h1 = template.content.querySelector('h1');
        // h1 && h1.remove();
        // var kicker = template.content.querySelector('.kicker');
        // kicker && kicker.remove();
        // var date = template.content.querySelector('.date');
        // date && date.remove();

        // Remove the first image if it's the same as the item image.
        // var image = template.content.querySelector('img');
        // if (image && this._isSameImageSrc(image.src, this.article.imageUrl)) {
        //   image.remove();
        // }

        // Remove the stupid style tags
        var styledElements = template.content.querySelectorAll('*[style]');
        for (var i = 0; i < styledElements.length; i++) {
          styledElements[i].removeAttribute('style');
        }

        // Remove width/height attributes from all images.
        var images = template.content.querySelectorAll('img');
        for (var i = 0; i < images.length; ++i) {
          var img = images[i];
          img.removeAttribute('width');
          img.removeAttribute('height');
        }

        return template.innerHTML;
      },

      // _isSameImageSrc: function(a, b) {
      //   var regex = /[^/]+\.(jpg|png|gif)/;
      //   var aMatch = regex.exec(a);
      //   var bMatch = regex.exec(b);
      //   return aMatch && bMatch && aMatch[0] === bMatch[0];
      // },

      _fetch: function(url, callback, attempts, isRaw) {
        var xhr = new XMLHttpRequest();
        xhr.addEventListener('load', function(e) {
          this._setLoading(false);
          if (isRaw) {
            callback(e.target.responseText);
          } else {
            callback(JSON.parse(e.target.responseText));
          }
        }.bind(this));
        xhr.addEventListener('error', function(e) {
          // Flaky connections might fail fetching resources
          if (attempts > 1) {
            this.debounce('_fetch', this._fetch.bind(this, url, callback, attempts - 1), 200);
          } else {
            this._setLoading(false);
            this._setFailure(true);
          }
        }.bind(this));

        this._setLoading(true);
        this._setFailure(false);
        xhr.open('GET', url);
        xhr.send();
      },

      refresh: function() {
        if (this.categoryName) {
          // Try at most 3 times to get the items.
          this._fetchCategory(this.category, this.offline, 3);
        }
      }

    });

  })();

  </script>

</dom-module>
